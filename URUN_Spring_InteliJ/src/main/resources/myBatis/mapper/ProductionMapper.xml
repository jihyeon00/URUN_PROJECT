<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.urun.mapper.ProductionMapper">
    <!--  생산작업관리 조회  -->
    <select id="getProcessList" resultType="kr.co.urun.dto.ProductionDTO">
        SELECT  p.PROCESS_Status,
                i.ITEM_NAME,
                p.PROCESS_ID,
                p.PROCESS_ITEM_ID,
                p.PROCESS_Plan_Quantity,
                p.PROCESS_LINE ,
                <!-- PROCESS_ID 의 (총 생산수, 총 불량수, 불량률) -->
                SUM(w.WORK_Item_Quantity) as WORK_Item_Quantity,
                SUM(w.WORK_Defective_Quantity) as WORK_Defective_Quantity,
                round(NVL(SUM(w.WORK_Defective_Quantity)/DECODE(SUM(w.WORK_Item_Quantity), 0, null, SUM(w.WORK_Item_Quantity)), 0),3) AS PROCESS_defect_rate,
                <!-- 생산시작날짜, 종료날짜 -->
                to_char(p.PROCESS_START_DATE,'yyyy-mm-dd') as PROCESS_START_DATE,
                to_char(p.PROCESS_END_DATE,'yyyy-mm-dd') as PROCESS_END_DATE
        FROM    PROCESS p, WORK w, ITEM i
        WHERE   p.PROCESS_ID = w.WORK_PROCESS_ID(+)
            AND p.PROCESS_ITEM_ID = i.ITEM_ID
        GROUP BY w.WORK_PROCESS_ID,
                 p.PROCESS_Status,
                 i.ITEM_NAME,
                 p.PROCESS_ITEM_ID,
                 p.PROCESS_ID,
                 p.PROCESS_LINE,
                 p.PROCESS_Plan_Quantity,
                 p.PROCESS_START_DATE,
                 p.PROCESS_END_DATE
        HAVING  1=1
        <!-- 제품이름검색 -->
        <if test="search_ITEM_NAME != null and search_ITEM_NAME != '' ">
            AND ITEM_NAME LIKE '%' || #{search_ITEM_NAME} || '%'
        </if>
        <!-- 제품코드검색 -->
        <if test="search_ITEM_ID != null and search_ITEM_ID != '' ">
            AND PROCESS_ITEM_ID LIKE '%' || #{search_ITEM_ID} || '%'
        </if>
        <!-- 생산시작날짜검색 -->
        <if test="search_START_DATE1 != null and search_START_DATE1 != ''
              and search_START_DATE2 != null and search_START_DATE2 != ''">
            AND PROCESS_START_DATE BETWEEN TO_DATE(#{search_START_DATE1}, 'yyyy-mm-dd')
                    AND TO_DATE(#{search_START_DATE2}, 'yyyy-mm-dd')
        </if>
        <!-- 생산종료날짜검색 -->
        <if test="search_END_DATE1 != null and search_END_DATE1 != ''
              and search_END_DATE2 != null and search_END_DATE2 != ''">
            AND PROCESS_END_DATE BETWEEN TO_DATE(#{search_END_DATE1}, 'yyyy-mm-dd')
                    AND TO_DATE(#{search_END_DATE2}, 'yyyy-mm-dd')
        </if>
        ORDER BY p.PROCESS_ID DESC
    </select>

    <!--  생산 불량 현황 조회  -->
    <select id="getStatusList" resultType="kr.co.urun.dto.ProductionDTO">
        SELECT  p.PROCESS_Status,
                i.ITEM_NAME,
                p.PROCESS_ITEM_ID,
                p.PROCESS_Plan_Quantity,
                <!-- PROCESS_ID 의 (총 생산수, 총 불량수, 불량률) -->
                SUM(w.WORK_Item_Quantity) as WORK_Item_Quantity,
                SUM(w.WORK_Defective_Quantity) as WORK_Defective_Quantity,
                round(NVL(SUM(w.WORK_Defective_Quantity)/DECODE(SUM(w.WORK_Item_Quantity), 0, null, SUM(w.WORK_Item_Quantity)), 0),3) AS PROCESS_defect_rate,
                <!-- 생산시작날짜, 종료날짜 -->
                to_char(p.PROCESS_START_DATE,'yyyy-mm-dd') as PROCESS_START_DATE,
                to_char(p.PROCESS_END_DATE,'yyyy-mm-dd') as PROCESS_END_DATE
        FROM    PROCESS p, WORK w, ITEM i
        WHERE   p.PROCESS_ID = w.WORK_PROCESS_ID(+)
            AND p.PROCESS_ITEM_ID = i.ITEM_ID
        GROUP BY    w.WORK_PROCESS_ID, p.PROCESS_Status, i.ITEM_NAME, p.PROCESS_ITEM_ID, p.PROCESS_ID,
                    p.PROCESS_Plan_Quantity, p.PROCESS_START_DATE, p.PROCESS_END_DATE
        HAVING 1=1
        <!-- 제품이름검색 -->
        <if test="search_ITEM_NAME != null and search_ITEM_NAME != '' ">
            AND ITEM_NAME LIKE '%' || #{search_ITEM_NAME} || '%'
        </if>
        <!-- 제품코드검색 -->
        <if test="search_ITEM_ID != null and search_ITEM_ID != '' ">
            AND PROCESS_ITEM_ID LIKE '%' || #{search_ITEM_ID} || '%'
        </if>
        <!-- 생산시작날짜검색 -->
        <if test="search_START_DATE1 != null and search_START_DATE1 != ''
              and search_START_DATE2 != null and search_START_DATE2 != ''">
            AND PROCESS_START_DATE BETWEEN TO_DATE(#{search_START_DATE1}, 'yyyy-mm-dd')
                    AND TO_DATE(#{search_START_DATE2}, 'yyyy-mm-dd')
        </if>
        <!-- 생산종료날짜검색 -->
        <if test="search_END_DATE1 != null and search_END_DATE1 != ''
              and search_END_DATE2 != null and search_END_DATE2 != ''">
            AND PROCESS_END_DATE BETWEEN TO_DATE(#{search_END_DATE1}, 'yyyy-mm-dd')
                    AND TO_DATE(#{search_END_DATE2}, 'yyyy-mm-dd')
        </if>
        ORDER BY p.PROCESS_ID DESC

    </select>
</mapper>